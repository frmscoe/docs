# The Tazama Logging Framework

## Architecture

At the heart of Tazama's logging stack, there is [pino], a fast json logger which is highly configurable. Tazama also uses the ELK stack for centralised logging of the logs generated by different microservices. There are 3 main components involved in the stack:

- logger
- [lumberjack]
- [event-sidecar]
- [nats]


### Logger
Tazama uses [pino] as the core logger. Which, at its core is a `json` logger. Pino utilises **transports** [^transport], which describe components that can be used to transmit and transform log output. Pino [recommends](https://github.com/pinojs/pino/blob/main/docs/transports.md#transports) that:

> ... that any log transformation or transmission is performed either in a separate thread or a separate process.

Which is where the event-sidecar comes in

### Event-Sidecar
As per the pino recommendation, the event-sidecar is a microservice that runs alongside a processor, capturing log events and transmitting them to a set destination [^lumberjack]. 

As the [event-sidecar] is running in a separate process, some inter-process-communication is required in order to transmit the logs from the main processor, to the [event-sidecar]. This is implemented using gRPC, which involves two pieces. A client, and a server.

#### Server
The [event-sidecar] itself, is a gRPC server that listens for requests sent by compatible clients following a specific format. The message sent is defined in a protobuf [format][wire]. An extract:

```proto
enum LogLevel {
  trace = 0;
  // omitted
  fatal = 5;
}
message LogMessage {
  string message = 1; // A message for the log
  LogLevel level = 2; // Log level
  // omitted
}

service Lumberjack {
  // Take a LogMessage object and an empty message
  rpc SendLog (LogMessage) returns (google.protobuf.Empty);
}
```

#### Client
Tazama abstracts away the need to write your own gRPC client. Simply initialising a logger and providing it with an address will create a gRPC Client behind the scenes which will send requests to the address that was provided.

An example:

```js
// No sidecar host is provided in the LoggerService constructor
const logger = new LoggerService();
```

An alternative implementation, **opting into** logging with the sidecar may be:
```js
const logger = new LoggerService("192.0.0.1:1234");
```
> [!NOTE]  
> If a sidecar host is provided in the `LoggerService` constructor, you have to ensure your sidecar is live on the address you provided

As gRPC is in use, it allows Tazama to be flexible enough to allow logs coming from any client (in any programming language) as long as it adheres to the type that the server expects (defined in the protobuf format above).

After receiving the logs, the [event-sidecar] sends them to [lumberjack] via [NATS]

### Lumberjack
Lumberjack is a microservice that receives all log events before redirecting them to a central place. This microservice utilises [NATS] to listen for incoming messages with a specific subject. The [event-sidecar] sends messages with a specific subject that [lumberjack] listens for. This microservice depends on [pino-elasticsearch](https://github.com/pinojs/pino-elasticsearch), which is what acts as our transport to transform our logs from our wire format (in the protofile), to the format that Elastic search expects.

This microservice has an additional responsibility of batching the received logs before transmission. This has a wide range of benefits as ultimately, I/O operations are reduced which will generally have implications on from improved performance coming from less network calls which can also affect costs in cloud environments.

## Implementation
The [event-sidecar] and [lumberjack] are optional components in implementation. Perhaps hardware is limited or there may be some situations whereby running more microservices is not ideal, Tazama will still have a functional logging implementation if the [event-sidecar] and [lumberjack] are excluded from deployment. As mentioned before, you can opt out in to using the [event-sidecar] and [lumberjack] for logging by specifying the sidecar host when initialising the logger service.

### Configuration

#### With Event-Sidecar and Lumberjack

##### Lumberjack

The following services are required:

- [NATS] - requires a [NATS] server to be running
- [Elastic search]() - log destination

A sample [.env](https://github.com/frmscoe/lumberjack/blob/ce6cda49bade1a0287bc0c603330e5fbb8159455/.env.example) is provided.

| Variable Name         | Purpose                               | Example             |
|-----------------------|---------------------------------------|---------------------|
| NATS_SERVER           | Specifies the NATS server address      | `nats://localhost:4222` |
| NATS_SUBJECT          | Defines the NATS subject/topic name    | `Lumberjack`        |
| ELASTIC_SEARCH_VERSION| Specifies the Elasticsearch version   | `8.11`              |
| ELASTIC_HOST          | Specifies the Elasticsearch host       | `http://localhost:9200` |
| ELASTIC_USERNAME      | Username for Elasticsearch authentication | `elastic_user`   |
| ELASTIC_PASSWORD      | Password for Elasticsearch authentication | `secretpassword` |
| FLUSHBYTES            | Specifies the number of bytes to flush | `1024`              |


##### Event-Sidecar
A sample [.env](https://github.com/frmscoe/event-sidecar/blob/feb5e53b0801f60fa746e1720349cfb8c09e6c2b/.env.example) is provided.

| Variable Name  | Purpose                              | Example                    |
|----------------|--------------------------------------|----------------------------|
| PORT           | Specifies the port number to use     | `8080`                     |
| NATS_SERVER    | Specifies the NATS server address    | `nats://localhost:4222`    |
| NATS_SUBJECT   | Defines the NATS subject/topic name  | `Lumberjack`               |

> [!CAUTION]
> Ensure the sidecar and lumberjack are pointing to the same instance of [NATS] and have the same subject

##### Processor
In your processor, add the [frms-coe-lib] as a dependency:

```sh
npm i @frmscoe/frms-coe-lib
```

In your processor, create an instance of a `LoggerService` and specify the [event-sidecar] address:

```ts
import { LoggerService } from '@frmscoe/frms-coe-lib';

const logger = new LoggerService("localhost:8080");
```
> [!CAUTION]
> Ensure the sidecar AND [lumberjack] start up before the processor so that logs are not missed.

#### Without Event-Sidecar and Lumberjack
In your processor, add the [frms-coe-lib] as a dependency:

```sh
npm i @frmscoe/frms-coe-lib
```

Configure your environment:
| Variable Name         | Purpose                               | Example             |
|-----------------------|---------------------------------------|---------------------|
| ELASTIC_SEARCH_VERSION| Specifies the Elasticsearch version   | `8.11`              |
| ELASTIC_HOST          | Specifies the Elasticsearch host       | `http://localhost:9200` |
| ELASTIC_USERNAME      | Username for Elasticsearch authentication | `elastic_user`   |
| ELASTIC_PASSWORD      | Password for Elasticsearch authentication | `secretpassword` |

In your processor, create an instance of a `LoggerService`:

```ts
import { LoggerService } from '@frmscoe/frms-coe-lib';

const logger = new LoggerService();
```
### Usage

You may specify a `LOGSTASH_LEVEL` environment variable in your processor to control your logs. The logging system supports multiple levels of severity, listed in ascending order of importance: `trace`, `debug`, `info`, `warn`, `error`, and `fatal`. When configuring the logging level, every log event with that level or a higher severity will be logged. For example, if you set the logging level to `info`, all log events at `info`, `warn`, `error`, and `fatal` levels will be logged. This ensures that important information and higher severity events are captured while filtering out less critical details.\

After initialising your logger, you may use the methods available to the `LoggerService` instance.

#### Logger Service 


##### Function Signature:

The custom logger function has the following signature for `trace`, `debug`, and `warn` log levels:

```typescript
trace(message: string, serviceOperation?: string, id?: string, callback?: LogCallback): void
debug(message: string, serviceOperation?: string, id?: string, callback?: LogCallback): void
log(message: string, serviceOperation?: string, id?: string, callback?: LogCallback): void
```

- **`message` (required)**: A string that represents the log message to be recorded.

- **`serviceOperation` (optional)**: Specifies the name or identifier of the service operation related to the log message. This parameter provides context about the operation being logged.

- **`id` (optional)**: An optional identifier associated with the log message. Use this parameter to correlate logs related to a specific transaction or request.

- **`callback` (optional)**: A callback function that can be provided to handle asynchronous logging operations or to receive notifications after logging. This parameter is optional and may not be used in all logging scenarios.

#### Usage:

- **`trace`**: Used for very detailed or fine-grained informational events. Example: tracing function calls.

- **`debug`**: Used for debugging purposes, providing detailed information for diagnosing issues.

- **`warn`**: Indicates potential issues that should be monitored or investigated.

#### Examples:

```typescript
// Example usage of the logger function
logger.log("Processing request...", "Rule901.determineOutcome", "12345");
```

In this example:
- `"Processing request..."` is the log message.
- `"Rule901.determineOutcome"` specifies the service operation context.
- `"12345"` is an optional identifier associated with the log message.

---

### Notes:

- Ensure to handle log messages appropriately based on their severity and impact on system performance.
- Utilize the optional parameters (`serviceOperation`, `id`, and `callback`) to provide detailed context and functionality as needed.
- Customize the logger implementation to integrate with your specific logging framework or requirements.

[pino]: https://github.com/pinojs/pino
[lumberjack]: https://github.com/frmscoe/lumberjack
[frms-coe-lib]: https://github.com/frmscoe/frms-coe-lib
[wire]: https://github.com/frmscoe/lumberjack
[NATS]: https://nats.io
[event-sidecar]: https://github.com/frmscoe/event-sidecar
[^transport]: [pino-elasticsearch](https://github.com/pinojs/pino-elasticsearch)
[^lumberjack]: [Lumberjack](https://github.com/frmscoe/lumberjack)
